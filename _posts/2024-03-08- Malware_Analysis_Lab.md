---
title: Unveiling the World of Malware Analysis 
categories: [Malware Analysis]
tags: [blueteam]
---
# A Journey into Setting Up Your Lab with QEMU/KVM


### Welcome, fellow enthusiasts, to the realm of cybersecurity, where the battle between defenders and attackers unfolds in the digital landscape. Today, we embark on an exciting journey to establish a Malware Analysis Lab, equipped with the potent combination of QEMU/KVM. (hehehe i ended up using this because my device is sucks).

# Host System Requirements:

    Processor (CPU):
        A multi-core processor with support for hardware virtualization (Intel VT-x or AMD-V) is highly recommended.
        More cores will allow for running multiple virtual machines simultaneously.

    Memory (RAM):
        Allocate at least 8GB of RAM to the host system.
        Consider increasing RAM if you plan to run multiple virtual machines concurrently or if you're dealing with resource-intensive malware samples.

    Storage:
        Ensure sufficient free disk space for hosting virtual machine images and other required files.
        An SSD is preferable for better I/O performance.

    Network:
        A stable network connection is essential for downloading malware samples and for virtual machines to communicate with each other.

# Prerequisites:

    Linux Host:
        Ensure that you have a Linux host system. Popular distributions like Ubuntu, Fedora, or CentOS work well.
        Install QEMU/KVM and related tools:

``` bash
    sudo apt-get install qemu-kvm libvirt-bin virtinst bridge-utils
``` 
        
# Hardware Virtualization Support:

    Confirm that your CPU supports hardware virtualization (Intel VT-x or AMD-V).
    Enable virtualization in your BIOS settings.



# Verify Virtualization Support:

    Confirm that virtualization is enabled on your CPU.


``` bash
egrep -c '(vmx|svm)' /proc/cpuinfo
```
![Imgur](https://i.imgur.com/XJO8d6b.png)

If the output is greater than 0, virtualization is supported.
    
    
# Install and Start libvirt:

    Start and enable the libvirt service.

``` bash
sudo systemctl start libvirtd
sudo systemctl enable libvirtd
sudo systemctl status libvirtd
```
    If everything is functioning properly, the output returns an active (running) status.

![Imgur](https://i.imgur.com/tWKN1iW.png)

# Authorize Users to Run Virtual Machines:

    To grant users the necessary permissions to run virtual machines, you need to add them to the libvirt and kvm user groups. Replace 'username' with the actual username of the user you want to authorize.

``` bash
sudo usermod -aG libvirt, kvm 'username'
```
# Download Windows 10, FlareVM, REMnux

- Windows ISO Download Link: https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise
- https://github.com/mandiant/flare-vm.git
- https://remnux.org/   

(Remember to convert vmdk file to qcow2)

# Creating a Virtual Machine 
``` bash
sudo apt update
sudo apt install virt-manager
```
# Start Virt-Manager

``` bash
virt-manager
```

![Imgur](https://i.imgur.com/MVjozFk.png)

    Create new VM by clicking this icon


![Imgur](https://i.imgur.com/GY5zRQY.png)

    If you have an ISO image use the first one
    If you have qcow2 file, use the third one
    After selecting click Forward

# FLARE-VM installation
Open a PowerShell prompt as administrator
Download the installation script installer.ps1 to your Desktop:

    (New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")

Unblock the installation script:

``` bash
Unblock-File .\install.ps1
```

Enable script execution:

``` bash 
Set-ExecutionPolicy Unrestricted -Force
```

If you receive an error saying the execution policy is overridden by a policy defined at a more specific scope, you may need to pass a scope in via Set-ExecutionPolicy Unrestricted -Scope CurrentUser -Force. To view execution policies for all scopes, execute Get-ExecutionPolicy -List

Finally, execute the installer script as follow:

``` bash
.\install.ps1
```

To pass your password as an argument: .\install.ps1 -password <password>
To use the CLI-only mode with minimal user interaction: .\install.ps1 -password <password> -noWait -noGui
To use the CLI-only mode with minimal user interaction and a custom config file: .\install.ps1 -customConfig <config.xml> -password <password> -noWait -noGui


See https://github.com/mandiant/flare-vm for more details.


The installation of Flare VM can take a considerable amount of time, depending on the number of included tools. Several factors contribute to the duration, including the size of files and the speed of your internet connection.

![Imgur](https://i.imgur.com/a5vK7MO.png)

# REMnux installation

If you download the file in https://docs.remnux.org/install-distro/get-virtual-appliance

This is what you get, extract it and convert it to qcow

![Imgur](https://i.imgur.com/gre7c42.png) 

Open Virtual Manager and Select import existing disk image

![Imgur](https://i.imgur.com/vjqk5w4.png)

When you try to run REMnux, at first it will all black but don't panic :>

![Imgur](https://i.imgur.com/MNFoHYe.png)

Click Send Key, and select Ctrl+Alt+F6 first for CLI and click Ctrl+Alt+F1 for GUI

```
USER: remnux
Password: malware
```

![Imgur](https://i.imgur.com/3UmHVdM.png)


# Network Setup